<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include('../layouts/admin/header') %>
    </head>
    <body>
      <% if(user.group_id == 111000){%>
        <%- include('../layouts/cbs/top-nav') %>
        <%- include('../layouts/cbs/side-bar') %>
    <% } else { %>
        <%- include('../layouts/admin/top-nav') %>
        <%- include('../layouts/admin/side-bar') %>
    <% } %>

            <!-- Page Sidebar Ends-->
            <div class="page-body">
                <div class="container-fluid">
                <div class="page-header">
                    <div class="row">
                    <div class="col-sm-6">
                        <h3>Offices </h3>
                        <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active">offices</li>
                        </ol>
                    </div>
                    <div class="col-sm-6">
                        <!-- Bookmark Start-->
                        <div class="bookmark">
                        <ul>
                            <li><a href="javascript:void(0)" data-container="body" data-bs-toggle="popover" data-placement="top" title="" data-original-title="Tables"><i data-feather="inbox"></i></a></li>
                            <li><a href="javascript:void(0)" data-container="body" data-bs-toggle="popover" data-placement="top" title="" data-original-title="Chat"><i data-feather="message-square"></i></a></li>
                            <li><a href="javascript:void(0)" data-container="body" data-bs-toggle="popover" data-placement="top" title="" data-original-title="Icons"><i data-feather="command"></i></a></li>
                            <li><a href="javascript:void(0)" data-container="body" data-bs-toggle="popover" data-placement="top" title="" data-original-title="Learning"><i data-feather="layers"></i></a></li>
                            <li><a href="javascript:void(0)"><i class="bookmark-search" data-feather="star"></i></a>
                            <form class="form-inline search-form">
                                <div class="form-group form-control-search">
                                <input type="text" placeholder="Search..">
                                </div>
                            </form>
                            </li>
                        </ul>
                        </div>
                        <!-- Bookmark Ends-->
                    </div>
                    </div>
                </div>
                </div>
                <!-- Container-fluid starts-->
                <div class="container-fluid">
                    <div class="row">
                       
                        <div class="col-sm-12">
                            <div class="card">
                                <div class="card-header pb-0">
                                <h5><button class="btn btn-success" data-bs-toggle="modal" data-original-title="test" data-bs-target="#exampleModal">Add Office</button></span>
                                </div>
                                
                                <div class="card-body">
                                    
                                    <div class="table-responsive">
                   
                                        <table  class="table display"  id="basic-10"  >
                                          <thead>
                                            <tr>
                                                <th>ACTION</th>
                                                <th>NAME</th>
                                                <th>ADDRESS</th>
                                                <th>EMAIL</th>
                                                <th>PHONE</th>
                                                <!-- <th>TYPE</th> -->
                                                <!-- <th>ADDRESS</th> -->
                                            </tr>
                                          </thead>
                                      <tbody>
                                           <% offices.forEach(function(View) { %> 
                                                <tr>   
                                                    <td>
                                                        <div class=" dropdown-basic">
                                                            <div class="dropdown">
                                                              <button class="dropbtn btn-primary" type="button">Actions <span><i class="icofont icofont-arrow-down"></i></span></button>
                                                              <div class="dropdown-content">
                                                                 <a href="javascript:;" data-bs-toggle="modal" data-original-title="test" data-bs-target="#exampleModal<%= View.id_tax_office %>">Edit details</a>
                                                                 <!-- <a href="javascript:;"  data-bs-toggle="modal" data-original-title="test" data-bs-target="#addStaff<%= View.id_tax_office %>" >Add staff</a> -->
                                                                <!-- <a href="javascript:;" >View transactions</a> -->
                                                                <a href="/admin/view_office_users?office_id=<%= View.tax_office_id %>">View Office User</a>
                                                                <!-- <a href="#">Ip Configurations</a></div> -->
                                                            </div>
                                                          </div>
                                                    </td>
                                                    <td><%= View.tax_office  %> </td>
                                                    <td><%= View.address %> </td>
                                                    <td><%= View.email %> </td>
                                                    <td><%= View.mobile_number %> </td>
                                                    <!-- <td><%= View.agencies_type %> </td> -->
                                                    <!-- <td><%= View.functions %> </td> -->
                                                </tr>
                                                <div class="modal fade" id="exampleModal<%= View.id_tax_office %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                  <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                      <div class="modal-header">
                                                        <h5 class="modal-title" id="exampleModalLabel">UPDATE AGENCY INFO</h5>
                                                        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                                                      </div>
                                                      <form class="form theme-form" method="post" id="form<%= View.id_tax_office %>" action="/submit">
                                                      <div class="modal-body">
                                                        
                                                            <div class="card-body">
                                                              <div class="row">
                                                                <div class="col">
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label" style="text-align: right;">Agency</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control" type="text" name="tax_office" id="tax_office" value="<%= View.tax_office  %>">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Email</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control" type="email" name="email" id="email" placeholder="" value="<%= View.email %>">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Mobile Number</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control digits" type="number" name="mobile_number" id="mobile_number" placeholder="" value="<%= View.mobile_number %> ">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Agency Type</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control " type="text" name="agencies_type" id="agencies_type" placeholder="" value="<%= View.agencies_type %>">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">functions</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control m-input digits" type="text" name="functions" id="functions" value="">
                                                                    </div>
                                                                  </div>
                                                                  <div class="row">
                                                                    <label class="col-sm-3 col-form-label" style="text-align: right;">Address</label>
                                                                    <div class="col-sm-9">
                                                                      <textarea class="form-control" rows="5" cols="5" placeholder="Default textarea" name="address" id="address"><%= View.address %></textarea>
                                                                    </div>
                                                                  </div>
                                                                </div>
                                                              </div>
                                                            </div>
                                                            <!-- <div class="card-footer text-end">
                                                              <div class="col-sm-9 offset-sm-3">
                                                                <button class="btn btn-primary" type="submit">Submit</button>
                                                                <input class="btn btn-light" type="reset" value="Cancel">
                                                              </div>
                                                            </div> -->
                                                          
                                                      </div>
                                                      <div class="modal-footer">
                                                        <button class="btn btn-primary" type="button" data-bs-dismiss="modal">Close</button>
                                                        <button class="btn btn-secondary" type="submit" onclick="submitEdit('<%= View.id_tax_office %>')">Save changes</button>
                                                      </div>
                                                    </form>
                                                    </div>
                                                  </div>
                                                </div>

                                                <!-- add office modal  -->
                                                <div class="modal fade" id="addStaff<%= View.id_tax_office %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                  <div class="modal-dialog" role="document">
                                                    <div class="modal-content">
                                                      <div class="modal-header">
                                                        <h5 class="modal-title" id="exampleModalLabel">Add Staff</h5>
                                                        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                                                      </div>
                                                      <form class="form theme-form" method="post" id="addform<%= View.id_tax_office %>" action="/submit">
                                                      <div class="modal-body">
                                                        
                                                            <div class="card-body">
                                                              <div class="row">
                                                                <div class="col">
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Staff Name</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control" type="text" name="name" id="name" placeholder="" value="">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Staff Number</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control" type="text" name="staff_numbe" id="staff_numbe" placeholder="" value="">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Email Address</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control" type="text" name="email" id="email" placeholder="" value="">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Phone number</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control" type="text" name="user_phone" id="user_phone" placeholder="" value="">
                                                                    </div>
                                                                  </div>
                                                                  
                                                                      <input class="form-control" type="hidden" name="tax_office" id="tax_office" readonly value="<%= View.id_tax_office  %>">
                                                                    
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">User tin</label>
                                                                    <div class="col-sm-9">
                                                                      <input class="form-control" type="text" name="tin" id="tin" placeholder="" value="">
                                                                    </div>
                                                                  </div>
                                                                  <div class="mb-3 row">
                                                                    <label class="col-sm-3 col-form-label"  style="text-align: right;">Staff Type</label>
                                                                    <div class="col-sm-9">
                                                                      <select name="group_id" id="group_id" class="form-control">
                                                                        <option value="">SELECT STAFF GROUP</option>
                                                                        <% usergroup.forEach(function(grp){%>
                                                                          <option value="<%= grp.group_id %>"><%= grp.group_name %></option>
                                                                        <%});%>
                                                                      </select>
                                                                      <!-- <input class="form-control digits" type="number" name="mobile_number" id="mobile_number" placeholder="" value="<%= View.mobile_number %> "> -->
                                                                    </div>
                                                                  </div>
                                                                  
                                                                </div>
                                                              </div>
                                                            </div>
                                                            <!-- <div class="card-footer text-end">
                                                              <div class="col-sm-9 offset-sm-3">
                                                                <button class="btn btn-primary" type="submit">Submit</button>
                                                                <input class="btn btn-light" type="reset" value="Cancel">
                                                              </div>
                                                            </div> -->
                                                          
                                                      </div>
                                                      <div class="modal-footer">
                                                        <button class="btn btn-primary" type="button" data-bs-dismiss="modal">Close</button>
                                                        <button class="btn btn-secondary" type="submit" onclick="addStaff('<%= View.id_tax_office %>')">Add staff</button>
                                                      </div>
                                                    </form>
                                                    </div>
                                                  </div>
                                                </div>
                                            <%});%>
                                          </tbody>
                                        </table>
                                       
                                    
                                      </div>

                                      
                                </div>

                                
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Container-fluid Ends-->
            </div>


            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered"  role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="exampleModalLabel">Create Office</h5>
                      <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                    <form class="form theme-form"  id="form" >
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label class="form-label" for="name">Office Name</label>
                            <input class="form-control"  name="tax_office" id="tax_office" type="text"  required="">
                            <!-- <div class="valid-feedback">Looks good!</div> -->
                          </div>
                          <div class="col-md-6">
                            <label class="form-label" for="email">Email</label>
                            <input class="form-control" type="email" name="email" id="email" required="">
                            <!-- <div class="valid-feedback">Looks good!</div> -->
                          </div>
                        </div>
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label class="form-label" for="user_phone">Phone</label>
                            <input class="form-control" id="user_phone" name="user_phone" type="text" placeholder="Phone Number" required="">
                            <div class="invalid-feedback">Please provide a valid city.</div>
                          </div>

                            <div class="col-md-6">
                              <label class="form-label" for="address">Office Address</label>
                              <textarea class="form-control"  placeholder="Default textarea" name="address" id="address"></textarea>
                              <!-- <div class="invalid-feedback">Please provide a valid city.</div> -->
                            </div>
                         
                        </div>
                       
                        <button class="btn btn-primary" type="submit" onclick="create()">Submit form</button>
                     
                  </form>
                  </div>
                  </div>
                </div>
              </div>


        <%- include('../layouts/admin/footer') %>
        <script>
            function submitEdit(id){
                let form = document.querySelector('#form'+id+'');

                form.addEventListener('submit', async(e)=> {
                    e.preventDefault()
                    let tax_office = form.tax_office.value;
                    let email = form.email.value;
                    let mobile_number = form.mobile_number.value;
                    let agencies_type = form.agencies_type.value;
                    let functions = form.functions.value;
                    let address = form.address.value;
                    console.log(tax_office, email, mobile_number, agencies_type, functions, address)
                    try {
                        let res = await fetch('/admin/edit_agency', {
                            method: "POST",
                            body: JSON.stringify({tax_office: tax_office, email:email, mobile_number: mobile_number, agencies_type:agencies_type, functions: functions, address:address, id:id}),
                            headers: {'Content-Type': 'application/json'}
                        })
            
                        const data = await res.json(); 
                        if(data.err) {
                            // formerror.textContent = data.err
                            var notify = $.notify('<i class="fa fa-warning"></i><strong>' +data.err+'</strong>.', {
                                    type: 'danger',
                                    allow_dismiss: true,
                                    delay: 5000,
                                    showProgressbar: true,
                                    timer: 300
                                });
                        } else {
                            
                                var notify = $.notify('<i class="fa fa-bell-o"></i><strong>Updated</strong>', {
                                    type: 'theme',
                                    allow_dismiss: true,
                                    delay: 2000,
                                    showProgressbar: true,
                                    timer: 1000
                                });

                                setTimeout(function() {
                                    notify.update('message', '<i class="fa fa-bell-o"></i><strong>Redirecting Back</strong>....');
                                    location.assign('/admin/view_offices')
                                }, 1000);
                        }
                    } catch (error) {
                        console.log(error)
                    }
                })
            }


            function addStaff(id){
                let form = document.querySelector('#addform'+id+'');

                form.addEventListener('submit', async(e)=> {
                    e.preventDefault()
                    $('#cover-spin').show(0)
                    let tax_office = form.tax_office.value;
                    let tin = form.tin.value;
                    let group_id = form.group_id.value;
                    let name = form.name;
                    let staff_numbe = form.staff_numbe;
                    let email = form.email;
                    let user_phone = form.user_phone;
                   
                    console.log(tax_office, tin, group_id)
                    try {
                        let res = await fetch('/admin/add_staff_to_office', {
                            method: "POST",
                            body: JSON.stringify({name: name, staff_numbe: staff_numbe, email: email, user_phone: user_phone, tax_office: tax_office, group_id: group_id, input:'addtooffice'}),
                            headers: {'Content-Type': 'application/json'}
                        })
            
                        const data = await res.json(); 
                        if(data.err) {
                            // formerror.textContent = data.err
                            $('#cover-spin').hide(0)
                            $(`#addStaff${id}`).modal('hide');
                            var notify = $.notify('<i class="fa fa-warning"></i><strong>' +data.err+'</strong>.', {
                                    type: 'danger',
                                    allow_dismiss: true,
                                    delay: 5000,
                                    showProgressbar: true,
                                    timer: 300
                                });
                        } else {
                               $('#cover-spin').hide(0)
                                var notify = $.notify('<i class="fa fa-bell-o"></i><strong>Updated</strong>', {
                                    type: 'theme',
                                    allow_dismiss: true,
                                    delay: 2000,
                                    showProgressbar: true,
                                    timer: 1000
                                });

                                setTimeout(function() {
                                    notify.update('message', '<i class="fa fa-bell-o"></i><strong>Redirecting Back</strong>....');
                                    location.assign('/admin/view_offices')
                                }, 1000);
                        }
                    } catch (error) {
                      $('#cover-spin').hide(0)
                        console.log(error)
                    }
                })
            }


            function create(){
                let form = document.querySelector('#form');
                form.addEventListener('submit', async(e)=> {
                    e.preventDefault()
                    $('#cover-spin').show(0)
                    let tax_office = form.tax_office.value;
                    let email = form.email.value;
                    let user_phone = form.user_phone.value;
                    let address = form.address.value;
                    console.log(tax_office, email, user_phone, address)
                    try {
                        let res = await fetch('/admin/view_offices', {
                            method: "POST",
                            body: JSON.stringify({tax_office: tax_office, email:email, user_phone: user_phone, address:address}),
                            headers: {'Content-Type': 'application/json'}
                        })
            
                        const data = await res.json(); 
                         $(`exampleModal`).modal('hide');
                        if(data.err) {
                          $('#cover-spin').hide(0)
                            // formerror.textContent = data.err
                            var notify = $.notify('<i class="fa fa-warning"></i><strong>' +data.err+'</strong>.', {
                                    type: 'danger',
                                    allow_dismiss: true,
                                    delay: 5000,
                                    showProgressbar: true,
                                    timer: 300
                                });
                        } else {
                          $('#cover-spin').hide(0)
                                var notify = $.notify('<i class="fa fa-bell-o"></i><strong>Created successfuly </strong>', {
                                    type: 'theme',
                                    allow_dismiss: true,
                                    delay: 2000,
                                    showProgressbar: true,
                                    timer: 1000
                                });

                                setTimeout(function() {
                                    notify.update('message', '<i class="fa fa-bell-o"></i><strong>Redirecting Back</strong>....');
                                    location.assign('/admin/view_offices')
                                }, 1000);
                        }
                    } catch (error) {
                        console.log(error)
                    }
                })
            }
        </script>
    </body>

</html>